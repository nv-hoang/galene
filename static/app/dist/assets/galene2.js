import{$ as g}from"./main.js";/*! js-cookie v3.0.5 | MIT */function q(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)e[r]=n[r]}return e}var it={read:function(e){return e[0]==='"'&&(e=e.slice(1,-1)),e.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent)},write:function(e){return encodeURIComponent(e).replace(/%(2[346BF]|3[AC-F]|40|5[BDE]|60|7[BCD])/g,decodeURIComponent)}};function te(e,t){function n(i,o,s){if(!(typeof document>"u")){s=q({},t,s),typeof s.expires=="number"&&(s.expires=new Date(Date.now()+s.expires*864e5)),s.expires&&(s.expires=s.expires.toUTCString()),i=encodeURIComponent(i).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape);var l="";for(var c in s)s[c]&&(l+="; "+c,s[c]!==!0&&(l+="="+s[c].split(";")[0]));return document.cookie=i+"="+e.write(o,i)+l}}function r(i){if(!(typeof document>"u"||arguments.length&&!i)){for(var o=document.cookie?document.cookie.split("; "):[],s={},l=0;l<o.length;l++){var c=o[l].split("="),y=c.slice(1).join("=");try{var d=decodeURIComponent(c[0]);if(s[d]=e.read(y,d),i===d)break}catch{}}return i?s[i]:s}}return Object.create({set:n,get:r,remove:function(i,o){n(i,"",q({},o,{expires:-1}))},withAttributes:function(i){return te(this.converter,q({},this.attributes,i))},withConverter:function(i){return te(q({},this.converter,i),this.attributes)}},{attributes:{value:Object.freeze(t)},converter:{value:Object.freeze(e)}})}var Me=te(it,{path:"/"});let M,a,k={},z=!1,S=null,b=null,ne=null;function oe(e){try{window.sessionStorage.setItem("settings",JSON.stringify(e)),ne=null}catch(t){console.warn("Couldn't store settings:",t),ne=e}}function w(){let e;try{let t=window.sessionStorage.getItem("settings");e=JSON.parse(t)}catch(t){console.warn("Couldn't retrieve settings:",t),e=ne}return e||{}}function P(e){let t=w();for(let n in e)t[n]=e[n];oe(t)}function ot(e,t){let n={};n[e]=t,P(n)}function Ue(e){let t=w();e in t&&(delete t[e],oe(t))}function U(e){let t=document.getElementById(e);if(!t||!(t instanceof HTMLSelectElement))throw new Error(`Couldn't find ${e}`);return t}function at(e){let t=document.getElementById(e);if(!t||!(t instanceof HTMLInputElement))throw new Error(`Couldn't find ${e}`);return t}function ae(e){let t=document.getElementById(e);if(!t||!(t instanceof HTMLButtonElement))throw new Error(`Couldn't find ${e}`);return t}function se(){let e=w(),t=!1;V(e.localMute);let n=U("videoselect");(!e.hasOwnProperty("video")||!Ce(n,e.video))&&(e.video=Ie(n),t=!0),n.value=e.video;let r=U("audioselect");(!e.hasOwnProperty("audio")||!Ce(r,e.audio))&&(e.audio=Ie(r),t=!0),r.value=e.audio,e.request="everything",t=!0,e.send="normal",e.simulcast="auto",t&&oe(e)}function Re(){return!!window.matchMedia("only screen and (max-width: 1024px)").matches}function Oe(e){document.getElementById("peers").childElementCount>0&&!e||(h("video-container",!1),pe())}function He(){let e=document.getElementById("peers").childElementCount>0;Re()&&(h("show-video",!1),h("collapse-video",e)),h("video-container",e),pe()}function le(){let e=navigator.userAgent.toLowerCase();return e.indexOf("safari")>=0&&e.indexOf("chrome")<0}let ye=null;function Ae(e){e?(Ke(),h("navbuttons",!0),h("disconnectbutton",!0),document.getElementById("loginDialog").close(),window.onresize=function(t){pe()},le()&&(ye||navigator.mediaDevices.getUserMedia({audio:!0}).then(t=>{ye=t})),g("#presentbutton").click()):(h("navbuttons",!1),h("disconnectbutton",!1),Oe(),window.onresize=null,window.location.href="/")}async function st(){Ae(!0),await lt()}async function lt(){let e=at("username").value.trim();Me.set("fullname",e);let t;if(S)switch(z=!1,t={type:"token",token:S},b){case null:b="probing",e=null;break;case"need-username":case"success":b=null;break;default:console.warn(`Unexpected probing state ${b}`),b=null;break}else{b!==null&&(console.warn(`Unexpected probing state ${b}`),b=null);let n="";k.authServer?(z=!1,t={type:"authServer",authServer:k.authServer,location:location.href,password:n}):(z=!0,t=n)}try{await a.join(M,e,t)}catch(n){console.error(n),f(n),a.close()}}function ct(){if(!w().forceRelay)return null;let e=this.rtcConfiguration,t={};for(let n in e)t[n]=e[n];return t.iceTransportPolicy="relay",t}function ut(e,t){fe(),Ae(!1),e!=1e3&&console.warn("Socket close",e,t);let n=document.getElementById("loginform");if(!(n instanceof HTMLFormElement))throw new Error("Bad type for loginform");n.active=!0}function dt(e){e.onclose=function(t){t||Ye(e.localId)},e.onerror=function(t){console.error(t),f(t.toString())},e.ondowntrack=function(t,n,r){R(e)},e.onnegotiationcompleted=function(){Bt(e)},e.onstatus=function(t){he(e)},e.onstats=gt,w().activityDetection&&e.setStatsInterval(mt),R(e)}function ce(){document.documentElement.style.setProperty("--vh",`${window.innerHeight/100}px`),He(),_()}addEventListener("resize",ce);addEventListener("orientationchange",ce);ae("presentbutton").onclick=async function(e){e.preventDefault();let t=this;if(!(t instanceof HTMLButtonElement))throw new Error("Unexpected type for this.");t.disabled=!0;try{j("camera")||await de()}finally{t.disabled=!1}};ae("unpresentbutton").onclick=function(e){e.preventDefault(),fe("camera"),_()};function h(e,t){g("#"+e).length&&(t?g("#"+e).show():g("#"+e).hide())}function x(){let e=a&&a.socket,t=a.permissions,n=!(typeof RTCPeerConnection>"u"),r=n&&"mediaDevices"in navigator&&"getUserMedia"in navigator.mediaDevices&&t.indexOf("present")>=0,i=n&&"mediaDevices"in navigator&&"getDisplayMedia"in navigator.mediaDevices&&t.indexOf("present")>=0,o=!!j("camera"),s=document.getElementById("peers").childElementCount,l=Re();h("presentbutton",r&&!o),h("unpresentbutton",o),h("mutebutton",!e||r),h("sharebutton",i),h("mediaoptions",r),h("sendform",r),h("simulcastform",r),h("collapse-video",s&&l)}function V(e,t){xt(e),e?(g("#mutebutton svg:first-child").hide(),g("#mutebutton svg:last-child").show()):(g("#mutebutton svg:last-child").hide(),g("#mutebutton svg:first-child").show()),t&&P({localMute:e})}U("videoselect").onchange=function(e){if(e.preventDefault(),!(this instanceof HTMLSelectElement))throw new Error("Unexpected type for this");P({video:this.value}),Ne()};U("audioselect").onchange=function(e){if(e.preventDefault(),!(this instanceof HTMLSelectElement))throw new Error("Unexpected type for this");P({audio:this.value}),Ne()};document.getElementById("mutebutton").onclick=function(e){e.preventDefault();let t=w().localMute;t=!t,V(t,!0)};document.getElementById("sharebutton").onclick=function(e){e.preventDefault(),It()};function ue(){let e=w().send;switch(e){case"lowest":return 15e4;case"low":return 3e5;case"normal":return 7e5;case"unlimited":return null;default:return console.error("Unknown video quality",e),7e5}}function Pe(e){switch(e){case"":return{};case"audio":return{"":["audio"]};case"screenshare":return{screenshare:["audio","video"],"":["audio"]};case"everything-low":return{"":["audio","video-low"]};case"everything":return{"":["audio","video"]};default:throw new Error(`Unknown value ${e} in request`)}}function ft(e,t){let n=Pe(e);return t in n?n[t]:n[""]}const mt=200,pt=700,ke=.2;function ht(e){let t=this,n=[];for(let r in e)if(e[r]&&e[r]["outbound-rtp"]){let i=e[r]["outbound-rtp"].rate;typeof i=="number"&&n.push(i)}n.length===0?ie(t,""):(n.sort((r,i)=>r-i),ie(t,n.map(r=>Math.round(r/1e3).toString()).reduce((r,i)=>r+"+"+i)))}function be(e,t){let n=document.getElementById("peer-"+e.localId);t?n.classList.add("peer-active"):n.classList.remove("peer-active")}function gt(e){let t=this,n=0;if(t.pc.getReceivers().forEach(r=>{let i=r.track&&r.track.id,o=i&&e[i],s=o&&o["inbound-rtp"]&&o["inbound-rtp"].audioEnergy;typeof s=="number"&&(n=Math.max(n,s))}),n>ke*ke)t.userdata.lastVoiceActivity=Date.now(),be(t,!0);else{let r=t.userdata.lastVoiceActivity;(!r||Date.now()-r>pt)&&be(t,!1)}}function Ee(e,t,n){n||(n=t);for(let i=0;i<e.children.length;i++){let o=e.children[i];if(!(o instanceof HTMLOptionElement)){console.warn("Unexpected select child");continue}if(o.value===n){o.label!==t&&(o.label=t);return}}let r=document.createElement("option");r.value=n,r.textContent=t,e.appendChild(r)}function Ce(e,t){let n=e.children;for(let r=0;r<n.length;r++){let i=e.children[r];if(!(i instanceof HTMLOptionElement)){console.warn("Unexpected select child");continue}if(i.value===t)return!0}return!1}function Ie(e){for(let t=0;t<e.children.length;t++){let n=e.children[t];if(!(n instanceof HTMLOptionElement)){console.warn("Unexpected select child");continue}if(n.value)return n.value}return""}let Se=!1;async function je(e){if(Se)return;let t=[];try{"mediaDevices"in navigator&&(t=await navigator.mediaDevices.enumerateDevices())}catch(i){console.error(i);return}let n=1,r=1;t.forEach(i=>{let o=i.label;i.kind==="videoinput"?(o||(o=`Camera ${n}`),Ee(U("videoselect"),o,i.deviceId),n++):i.kind==="audioinput"&&(o||(o=`Microphone ${r}`),Ee(U("audioselect"),o,i.deviceId),r++)}),Se=e}function N(e){let t=a.newUpStream(e);return t.onstatus=function(n){he(t)},t.onerror=function(n){console.error(n),f(n)},t}async function wt(e,t,n){if(!e.up)throw new Error("Setting throughput of down stream");e.label==="screenshare"&&(n=!1);let r=e.pc.getSenders();for(let i=0;i<r.length;i++){let o=r[i];if(!o.track||o.track.kind!=="video")continue;let s=o.getParameters();if(!s.encodings||!n&&s.encodings.length!=1||n&&s.encodings.length!=2){await Ve(e);return}s.encodings.forEach(l=>{(!l.rid||l.rid==="h")&&(l.maxBitrate=t||re)}),await o.setParameters(s)}}let W=null;async function qe(){Fe();let e=ue(),t=We(),n=[];for(let r in a.up){let i=a.up[r];n.push(wt(i,e,t))}await Promise.all(n)}function vt(){Fe(),W=setTimeout(qe,1e4+Math.random()*1e4)}function Fe(){W&&(clearTimeout(W),W=null)}function H(e,t){if(!HTMLCanvasElement.prototype.captureStream)throw new Error("Filters are not supported on this platform");this.inputStream=e,this.definition=t,this.frameRate=30,this.video=document.createElement("video"),this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.captureStream=null,this.outputStream=null,this.timer=null,this.count=0,this.fixedFramerate=!1,this.userdata={},this.captureStream=this.canvas.captureStream(0),this.busy=!1}H.prototype.start=async function(){this.captureStream.getTracks()[0].requestFrame||(console.warn("captureFrame not supported, using fixed framerate"),this.captureStream=this.canvas.captureStream(this.frameRate),this.fixedFramerate=!0),this.outputStream=new MediaStream,this.outputStream.addTrack(this.captureStream.getTracks()[0]),this.inputStream.getTracks().forEach(e=>{e.onended=t=>this.stop(),e.kind!="video"&&this.outputStream.addTrack(e)}),this.video.srcObject=this.inputStream,this.video.muted=!0,this.video.play(),this.definition.init&&await this.definition.init.call(this),this.timer=setInterval(()=>this.draw(),1e3/this.frameRate)};H.prototype.draw=async function(){if(!(this.video.videoWidth===0&&this.video.videoHeight===0)){if(this.count%30===0){let e=0;this.inputStream.getTracks().forEach(t=>{if(t.kind==="video"){let n=t.getSettings().frameRate;n&&(e=n)}}),e&&e!=this.frameRate&&(clearInterval(this.timer),this.timer=setInterval(()=>this.draw(),1e3/this.frameRate))}if(!this.busy)try{this.busy=!0;let e=!1;try{e=await this.definition.draw.call(this,this.video,this.context)}catch(t){console.error(t)}e&&!this.fixedFramerate&&this.captureStream.getTracks()[0].requestFrame(),this.count++}finally{this.busy=!1}}};H.prototype.stop=async function(){this.timer&&(this.captureStream.getTracks()[0].stop(),clearInterval(this.timer),this.timer=null,this.definition.cleanup&&await this.definition.cleanup.call(this))};async function G(e){let t=e.userdata.filter;if(t){if(!(t instanceof H))throw new Error("userdata.filter is not a filter");e.setStream(t.inputStream),await t.stop(),e.userdata.filter=null}}async function yt(e){if(await G(e),!e.userdata.filterDefinition)return;let t=new H(e.stream,e.userdata.filterDefinition);await t.start(),e.setStream(t.outputStream),e.userdata.filter=t}async function xe(e,t,n){let r=new Promise((i,o)=>{e.onmessage=s=>{s&&s.data?s.data instanceof Error?o(s.data):i(s.data):i(null)}});return e.postMessage(t,n),await r}let kt={"mirror-h":{description:"Horizontal mirror",draw:async function(e,t){if(!(t instanceof CanvasRenderingContext2D))throw new Error("bad context type");return(t.canvas.width!==e.videoWidth||t.canvas.height!==e.videoHeight)&&(t.canvas.width=e.videoWidth,t.canvas.height=e.videoHeight),t.scale(-1,1),t.drawImage(e,-e.videoWidth,0),t.resetTransform(),!0}},"mirror-v":{description:"Vertical mirror",draw:async function(e,t){if(!(t instanceof CanvasRenderingContext2D))throw new Error("bad context type");return(t.canvas.width!==e.videoWidth||t.canvas.height!==e.videoHeight)&&(t.canvas.width=e.videoWidth,t.canvas.height=e.videoHeight),t.scale(1,-1),t.drawImage(e,0,-e.videoHeight),t.resetTransform(),!0}},"background-blur":{description:"Background blur",predicate:async function(){if(le())return console.warn("Background blur does not work on Safari, disabled."),!1;let e=await fetch("/third-party/tasks-vision/vision_bundle.mjs",{method:"HEAD"});return e.ok?!0:(e.status!==404&&console.warn(`Fetch vision_bundle.mjs: ${e.status} ${e.statusText}`),!1)},init:async function(e){if(!(this instanceof H))throw new Error("Bad type for this");if(this.userdata.worker)throw new Error("Worker already running (this shouldn't happen)");this.userdata.worker=new Worker("/background-blur-worker.js"),await xe(this.userdata.worker,{model:"/third-party/tasks-vision/models/selfie_segmenter.tflite"})},cleanup:async function(){this.userdata.worker.onmessage&&this.userdata.worker.onmessage(null),this.userdata.worker.terminate(),this.userdata.worker=null},draw:async function(e,t){let n=await createImageBitmap(e);try{let r=await xe(this.userdata.worker,{bitmap:n,timestamp:performance.now()},[n]);if(!r)return!1;let i=r.mask;n=r.bitmap,(t.canvas.width!==e.videoWidth||t.canvas.height!==e.videoHeight)&&(t.canvas.width=e.videoWidth,t.canvas.height=e.videoHeight),t.globalCompositeOperation="copy",t.filter="none",t.drawImage(i,0,0),t.globalCompositeOperation="source-in",t.filter="none",t.drawImage(r.bitmap,0,0),t.globalCompositeOperation="copy",t.filter=`blur(${e.videoWidth/48}px)`,t.drawImage(t.canvas,0,0),t.globalCompositeOperation="destination-atop",t.filter="none",t.drawImage(r.bitmap,0,0),t.globalCompositeOperation="source-over",i.close()}finally{n.close()}return!0}}};async function bt(){}const re=1e9,ze=1e5,Et=128e3;function We(){switch(w().simulcast){case"on":return!0;case"off":return!1;default:let e=0;for(let n in a.users)if(!a.users[n].permissions.system&&(e++,e>2))break;if(e<=2)return!1;let t=ue();return t<=0||t>=2*ze}}async function Y(e,t){if(e.stream!=null)throw new Error("Setting nonempty stream");e.setStream(t),e.onclose=async r=>{await G(e),r||(Ge(e.stream),e.userdata.onclose&&e.userdata.onclose.call(e),Ye(e.localId))},await yt(e);function n(r){let i=w();e.label==="camera"&&(r.kind=="audio"?i.localMute&&(r.enabled=!1):r.kind=="video"&&i.blackboardMode&&(r.contentHint="detail")),r.onended=c=>{t.onaddtrack=null,t.onremovetrack=null,e.close()};let o=[],s=e.label!=="screenshare"&&We();if(r.kind==="video"){let c=ue();s?(o.push({rid:"h",maxBitrate:c||re}),o.push({rid:"l",scaleResolutionDownBy:2,maxBitrate:ze})):o.push({maxBitrate:c||re})}else i.hqaudio&&o.push({maxBitrate:Et});let l=e.pc.addTransceiver(r,{direction:"sendonly",streams:[t],sendEncodings:o});try{let c=l.sender.getParameters();c.encodings||(c.encodings=o,l.sender.setParameters(c))}catch{}}e.stream.getTracks().forEach(n),t.onaddtrack=function(r){n(r.track)},t.onremovetrack=function(r){let i=r.track,o;e.pc.getSenders().forEach(l=>{l.track===i&&(o=l)}),o?e.pc.removeTrack(o):console.warn("Removing unknown track");let s=!1;e.pc.getSenders().forEach(l=>{l.track&&(s=!0)}),s||(t.onaddtrack=null,t.onremovetrack=null,e.close())},e.onstats=ht,e.setStatsInterval(2e3)}async function Ve(e){await G(e);let t=N(e.localId);t.label=e.label,e.userdata.filterDefinition&&(t.userdata.filterDefinition=e.userdata.filterDefinition),e.userdata.onclose&&(t.userdata.onclose=e.userdata.onclose);let n=document.getElementById("media-"+e.localId);try{await Y(t,e.stream)}catch(r){return console.error(r),f(r),t.close(),e.close(),null}return await R(t,t.label=="camera"&&w().mirrorView,t.label=="video"&&n),t}async function Ct(e){let t=[];for(let n in a.up){let r=a.up[n];e&&r.label!==e||t.push(Ve(r))}await Promise.all(t)}function Ne(){let e=j("camera");e&&de(e.localId)}async function de(e){let t=w(),n=t.audio?{deviceId:t.audio}:!1,r=t.video?{deviceId:t.video}:!1;if(r){let c=t.resolution;c?(r.width={ideal:c[0]},r.height={ideal:c[1]}):t.blackboardMode?(r.width={min:640,ideal:1920},r.height={min:400,ideal:1080}):r.aspectRatio={ideal:4/3}}n&&(t.preprocessing||(n.echoCancellation=!1,n.noiseSuppression=!1,n.autoGainControl=!1));let i=a.findByLocalId(e);i&&(await G(i),Ge(i.stream));let o={audio:n,video:r},s=null;try{s=await navigator.mediaDevices.getUserMedia(o)}catch(c){f(c);return}je(!0);let l;try{l=N(e)}catch(c){console.log(c),f(c);return}if(l.label="camera",t.filter){let c=kt[t.filter];c?l.userdata.filterDefinition=c:O(`Unknown filter ${t.filter}`)}try{await Y(l,s),await R(l,t.mirrorView)}catch(c){console.error(c),f(c),l.close()}x()}let Le=!1;async function It(){if(!Le){if(le()&&!confirm("Screen sharing in Safari is broken.  It will work at first, but then your video will randomly freeze.  Are you sure that you wish to enable screensharing?"))return;Le=!0}let e=null;try{if(!("getDisplayMedia"in navigator.mediaDevices))throw new Error("Your browser does not support screen sharing");e=await navigator.mediaDevices.getDisplayMedia({video:!0,audio:!0})}catch(n){console.error(n),f(n);return}let t=N();t.label="screenshare",await Y(t,e),await R(t),x()}async function St(e){let t=URL.createObjectURL(e),n=document.createElement("video");n.src=t,n.controls=!0;let r;if(n.captureStream)r=n.captureStream();else if(n.mozCaptureStream)r=n.mozCaptureStream();else{f("This browser doesn't support file playback");return}let i=N();i.label="video",i.userdata.onclose=function(){let l=document.getElementById("media-"+this.localId);l&&l.src&&(URL.revokeObjectURL(l.src),l.src=null)},await Y(i,r);let o=!!j("camera"),s=w().localMute;o&&!s&&(V(!0,!0),O("You have been muted")),await R(i,!1,n),i.userdata.play=!0,x()}function Ge(e){e.getTracks().forEach(t=>{try{t.stop()}catch(n){console.warn(n)}})}function fe(e){for(let t in a.up){let n=a.up[t];e&&n.label!==e||n.close()}}function j(e){if(!a)return null;for(let t in a.up){let n=a.up[t];if(n.label===e)return n}return null}function xt(e){if(a)for(let t in a.up){let n=a.up[t];n.label==="camera"&&n.stream.getTracks().forEach(i=>{i.kind==="audio"&&(i.enabled=!e)})}}function Lt(e,t,n){let r=a.down[e];if(!r)throw new Error("Unknown down stream");"requested"in r.userdata?t?r.userdata.requested.force=!!n:delete r.userdata.requested.force:t&&(r.userdata.requested={force:n}),me(e)}function Tt(e){let t=[],n=!1;for(let r=0;r<e.length;r++){let i=e[r];i==="video"&&(i="video-low",n=!0),t.push(i)}return n?t:null}function me(e){if(!a)return;if(!e){for(let s in a.down)me(s);return}let t=a.down[e];if(!t)throw new Error("Unknown down stream");let n=ft(w().request,t.label),r=Tt(n);if(r===null)return;let i=t.userdata.requested,o=!1;if(i&&"force"in i)o=i.force;else{let s=document.getElementById("media-"+t.localId);if(!s)throw new Error("No media for stream");let l=s.scrollWidth,c=s.scrollHeight;l&&c&&l*c<=320*240&&(o=!0)}o!==!!(i&&i.low)&&("requested"in t.userdata?t.userdata.requested.low=o:t.userdata.requested={low:o},t.request(o?r:null))}let X=null;function pe(){X||(X=setTimeout(()=>{X=null,me()},200))}async function R(e,t,n){let r=document.getElementById("peer-"+e.localId);r||(r=document.createElement("div"),r.id="peer-"+e.localId,r.classList.add("peer"),g('<div class="peer-user">'+e.sc.username+"</div>").appendTo(r),document.getElementById("peers").appendChild(r)),Dt(e,r);let i=document.getElementById("media-"+e.localId);i||(n?i=n:(i=document.createElement("video"),e.up&&(i.muted=!0)),i.classList.add("media"),i.classList.add(e.label),i.autoplay=!0,i.playsInline=!0,i.id="media-"+e.localId,r.appendChild(i)),t?i.classList.add("mirror"):i.classList.remove("mirror"),!n&&i.srcObject!==e.stream&&(i.srcObject=e.stream),e.up||(i.onfullscreenchange=function(o){Lt(e.id,document.fullscreenElement===i,!1)}),ie(e),he(e),He(),_()}function Dt(e,t){let n=e.up||w().displayAll;if(!n&&e.stream){let r=e.stream.getTracks();for(let i=0;i<r.length;i++)if(r[i].kind==="video"){n=!0;break}}n?t.classList.remove("peer-hidden"):t.classList.add("peer-hidden")}function Bt(e){let t=document.getElementById("media-"+e.localId);if(!t){console.error("Resetting unknown media element");return}t.srcObject=t.srcObject}function Ye(e){let t=document.getElementById("peers"),n=document.getElementById("peer-"+e);if(!n)throw new Error("Removing unknown media");let r=document.getElementById("media-"+e);r.srcObject=null,t.removeChild(n),x(),_(),Oe()}function he(e){let t=e&&e.pc&&e.pc.iceConnectionState,n=t==="connected"||t==="completed",r=document.getElementById("media-"+e.localId);if(!r){console.warn("Setting status of unknown media.");return}n?(r.classList.remove("media-failed"),e.userdata.play&&(r instanceof HTMLMediaElement&&r.play().catch(i=>{console.error(i),f(i)}),delete e.userdata.play)):r.classList.add("media-failed")}function ie(e,t){let n=document.getElementById("label-"+e.localId);if(!n)return;let r=e.username;r?(n.textContent=r,n.classList.remove("label-fallback")):t?(n.textContent=t,n.classList.add("label-fallback")):(n.textContent="",n.classList.remove("label-fallback"))}function _(){if(!a)return;let e=Object.keys(a.up).length+Object.keys(a.down).length,t=document.getElementById("peers"),n=Math.ceil(Math.sqrt(e));if(!e)return;let r=document.getElementById("video-container");e<=2&&r.offsetHeight>r.offsetWidth?t.style["grid-template-columns"]="repeat(1, 1fr)":t.style["grid-template-columns"]=`repeat(${n}, 1fr)`}function $t(e,t){let n=e.toLowerCase(),r=t.toLowerCase();return n<r?-1:n>r?1:e<t?-1:e>t?1:0}function Mt(e,t){let n=document.getElementById("users"),r=document.createElement("div");r.id="user-"+e,r.classList.add("user-p"),_e(e,r,t);let i=n.children;if(e===a.id){i.length===0?n.appendChild(r):n.insertBefore(r,i[0]);return}if(t.username)for(let o=0;o<i.length;o++){let s=i[o],l=s.id.slice(5);if(l===a.id)continue;let c=a.users[l]||null,y=c&&c.username||null;if(!y||$t(y,t.username)>0){n.insertBefore(r,s);return}}n.appendChild(r)}function Ut(e,t){let n=document.getElementById("user-"+e);if(!n){console.warn("Unknown user "+e);return}_e(e,n,t)}function _e(e,t,n){t.textContent=n.username?n.username:"(anon)",n.data.raisehand?t.classList.add("user-status-raisehand"):t.classList.remove("user-status-raisehand");let r=!1,i=!1;for(let o in n.streams)for(let s in n.streams[o])s=="audio"?r=!0:i=!0;i?(t.classList.remove("user-status-microphone"),t.classList.add("user-status-camera")):r?(t.classList.add("user-status-microphone"),t.classList.remove("user-status-camera")):(t.classList.remove("user-status-microphone"),t.classList.remove("user-status-camera"))}function Rt(e){let t=document.getElementById("users"),n=document.getElementById("user-"+e);t.removeChild(n)}function Ot(e,t){switch(t){case"add":Mt(e,a.users[e]),Object.keys(a.users).length==3&&qe();break;case"delete":Rt(e),Object.keys(a.users).length<3&&vt();break;case"change":Ut(e,a.users[e]);break;default:console.warn("Unknown user kind",t);break}}let Te=null;function Je(e){return e.length<=0?e:e.charAt(0).toUpperCase()+e.slice(1)}async function Ht(e,t,n,r,i,o,s){let l=Te;switch(Te=null,e){case"fail":b==="probing"&&o==="need-username"?b="need-username":(S=null,f("The server said: "+s)),this.close(),x();return;case"redirect":this.close(),S=null,document.location.href=s;return;case"leave":this.close(),x();return;case"join":case"change":if(b==="probing"){b="success",this.close(),x();return}else S=null;for(let c in r)k[c]=r[c];if(r&&r.displayName||Je(t),x(),z&&k.canChangePassword&&a.username,e==="change")return;break;default:S=null,f("Unknown join message"),this.close();return}if(document.getElementById("input"),r.locked&&O("This group is locked"),typeof RTCPeerConnection>"u"?O("This browser doesn't support WebRTC"):this.request(Pe(w().request)),"mediaDevices"in navigator&&"getUserMedia"in navigator.mediaDevices&&a.permissions.indexOf("present")>=0&&!j("camera")&&l){l==="mike"?P({video:""}):l==="both"&&Ue("video"),se();let c=ae("presentbutton");c.disabled=!0;try{await de()}finally{c.disabled=!1}}}function At(e){e.onevent=jt;let t=document.createElement("p");e.up?t.textContent=`We have offered to send a file called "${e.name}" to user ${e.username}.`:t.textContent=`User ${e.username} offered to send us a file called "${e.name}" of size ${e.size}.`;let n=null,r=null;e.up||(r=document.createElement("button"),r.textContent="Accept",r.onclick=function(c){e.receive()},r.id="byes-"+e.fullid()),n=document.createElement("button"),n.textContent=e.up?"Cancel":"Reject",n.onclick=function(c){e.cancel()},n.id="bno-"+e.fullid();let i=document.createElement("span");i.id="status-"+e.fullid(),e.up||(i.textContent='(Choosing "Accept" will disclose your IP address.)');let o=document.createElement("p");o.id="statusp-"+e.fullid(),o.appendChild(i);let s=document.createElement("div");return s.id="file-"+e.fullid(),s.appendChild(t),r&&s.appendChild(r),n&&s.appendChild(n),s.appendChild(o),s.classList.add("message"),s.classList.add("message-private"),s.classList.add("message-row"),document.getElementById("box").appendChild(s),s}function A(e,t,n){let r=document.getElementById("status-"+e.fullid());if(!r)throw new Error("Couldn't find statusp");if(r.textContent=t,n){let i=document.getElementById("progress-"+e.fullid());if(!i||!(i instanceof HTMLProgressElement))throw new Error("Couldn't find progress element");i.value=n;let o=document.getElementById("progresstext-"+e.fullid()),s=Math.round(100*n/i.max);o.textContent=`${s}%`}}function Pt(e,t){let n=document.getElementById("statusp-"+e.fullid());if(!n)throw new Error("Couldn't find status div");let r=document.createElement("progress");r.id="progress-"+e.fullid(),r.classList.add("file-progress"),r.max=t,r.value=0,n.appendChild(r);let i=document.createElement("span");i.id="progresstext-"+e.fullid(),i.textContent="0%",n.appendChild(i)}function ee(e,t,n,r){let i=document.getElementById("file-"+e.fullid());if(!i)throw new Error("Couldn't find file div");if(t){let o=document.getElementById("byes-"+e.fullid());o&&i.removeChild(o)}if(n){let o=document.getElementById("bno-"+e.fullid());o&&i.removeChild(o)}if(r){let o=document.getElementById("statusp-"+e.fullid()),s=document.getElementById("progress-"+e.fullid()),l=document.getElementById("progresstext-"+e.fullid());s&&o.removeChild(s),l&&o.removeChild(l)}}function jt(e,t){let n=this;switch(e){case"inviting":break;case"connecting":ee(n,!0,!1),A(n,"Connecting..."),Pt(n,n.size);break;case"connected":A(n,n.up?"Sending...":"Receiving...",n.datalen);break;case"done":if(ee(n,!0,!0,!0),A(n,"Done."),!n.up){let r=URL.createObjectURL(t),i=document.createElement("a");i.href=r,i.textContent=n.name,i.download=n.name,i.type=n.mimetype,i.click(),URL.revokeObjectURL(r)}break;case"cancelled":ee(n,!0,!0,!0),t?A(n,`Cancelled: ${t.toString()}.`):A(n,"Cancelled.");break;case"closed":break;default:console.error(`Unexpected state "${e}"`),n.cancel(`unexpected state "${e}" (this shouldn't happen)`);break}}function qt(e,t,n,r,i,o,s,l){switch(o){case"kicked":case"error":case"warning":case"info":if(!i){console.error(`Got unprivileged message of kind ${o}`);return}f(`${e?n||"Anonymous":"The Server"} said: ${l}`,o);break;case"mute":if(!i){console.error(`Got unprivileged message of kind ${o}`);return}V(!0,!0);let y=n?" by "+n:"";O(`You have been muted${y}`);break;case"clearchat":{if(!i){console.error(`Got unprivileged message of kind ${o}`);return}let m=l&&l.id,p=l&&l.userId;Ke(m,p);break}case"token":if(!i){console.error(`Got unprivileged message of kind ${o}`);return}if(s){f(`Token operation failed: ${l}`);return}if(typeof l!="object"){f("Unexpected type for token");return}let d=De(l,!1);if(L(d[0]+": "+d[1]),"share"in navigator)try{navigator.share({title:`Invitation to Galene group ${l.group}`,text:d[0],url:d[1]})}catch(m){console.warn("Share failed",m)}break;case"tokenlist":if(!i){console.error(`Got unprivileged message of kind ${o}`);return}if(s){f(`Token operation failed: ${l}`);return}let C="";for(let m=0;m<l.length;m++){let p=De(l[m],!0);C=C+p[0]+": "+p[1]+`
`}L(C);break;case"userinfo":if(!i){console.error(`Got unprivileged message of kind ${o}`);return}let D=l.username?"username "+l.username:"unknown username",I=l.address?"address "+l.address:"unknown address";L(`User ${l.id} has ${D} and ${I}.`);break;default:console.warn(`Got unknown user message ${o}`);break}}function De(e,t){let n=new URL(window.location.href),r=new URLSearchParams;r.append("token",e.token),n.search=r.toString();let i="",o="",s="";e.username&&(i=` for user ${e.username}`),t?(e.issuedBy&&(o=" issued by "+e.issuedBy),e.issuedAt&&(o===""?o=" issued at "+e.issuedAt:o=o+" at "+new Date(e.issuedAt).toLocaleString())):e.group&&(s=" to group "+e.group);let l="";e["not-before"]&&(l=` since ${new Date(e["not-before"]).toLocaleString()}`);let c=null,y="";return e.expires&&(c=new Date(e.expires),y=` until ${c.toLocaleString()}`),[c&&c>=new Date?`Invitation${i}${s}${o} valid${l}${y}`:`Expired invitation${i}${s}${o}`,n.toString()]}const Ft=/https?:\/\/[-a-zA-Z0-9@:%/._\\+~#&()=?]+[-a-zA-Z0-9@:%/_\\+~#&()=]/g;function zt(e){let t=new RegExp(Ft),n=[],r=0;for(;;){let o=t.exec(e);if(!o)break;n.push(document.createTextNode(e.slice(r,o.index)));let s=document.createElement("a");s.href=o[0],s.textContent=o[0],s.target="_blank",s.rel="noreferrer noopener",n.push(s),r=o.index+o[0].length}n.push(document.createTextNode(e.slice(r)));let i=document.createElement("div");return n.forEach(o=>{i.appendChild(o)}),i}function Wt(e){let t=Date.now()-e.getTime(),n=e.getMinutes();return t>-3e4?e.getHours()+":"+(n<10?"0":"")+n:e.toLocaleString()}let E={};function ge(e,t,n,r,i,o,s,l,c){if(l==="caption"){Nt(c);return}let y=document.createElement("div");y.classList.add("message-row");let d=document.createElement("div");d.classList.add("message"),y.appendChild(d);let C=document.createElement("p");C.classList.add("message-footer"),t||d.classList.add("message-system"),a&&t===a.id&&d.classList.add("message-sender"),n&&d.classList.add("message-private"),e&&(d.dataset.id=e),t&&(d.dataset.peerId=t,d.dataset.username=r,d.addEventListener("click",function(m){if(m.detail!==2)return;let p=m.currentTarget;if(!p||!(p instanceof HTMLElement))throw new Error("Couldn't find chat message div");Vt(p)}));let D;if(c instanceof HTMLElement)D=c;else if(typeof c=="string")D=zt(c);else throw new Error("Cannot add element to chatbox");if(l!=="me"){let m=!0;if(E.nick!==(r||null)||E.peerId!==(t||null)||E.dest!==(n||null)||!i||!E.time)m=!0;else{let B=i.getTime()-E.time.getTime();m=B<0||B>6e4}if(m){let B=document.createElement("p"),Z=document.createElement("span"),ve=n&&a.users[n],rt=ve&&ve.username;if(Z.textContent=n?`${r||"(anon)"} â†’ ${rt||"(anon)"}`:r||"(anon)",Z.classList.add("message-user"),B.appendChild(Z),B.classList.add("message-header"),d.appendChild(B),i){let Q=document.createElement("span");Q.textContent=Wt(i),Q.classList.add("message-time"),B.appendChild(Q)}}let p=document.createElement("p");p.appendChild(D),p.classList.add("message-content"),d.appendChild(p),E.nick=r||null,E.peerId=t,E.dest=n||null,E.time=i||null}else{let m=document.createElement("span");m.textContent="*",m.classList.add("message-me-asterisk");let p=document.createElement("span");p.textContent=r||"(anon)",p.classList.add("message-me-user"),D.classList.add("message-me-content"),d.appendChild(m),d.appendChild(p),d.appendChild(D),d.classList.add("message-me"),E={}}d.appendChild(C);let I=document.getElementById("box");I.appendChild(y),I.scrollHeight>I.clientHeight&&(I.scrollTop=I.scrollHeight-I.clientHeight)}function Vt(e){if(!(a&&a.permissions&&a.permissions.indexOf("op")>=0))return;let t=e.dataset.id,n=e.dataset.peerId;if(!n)return;let i=e.dataset.username||"user",o=[];t&&o.push({label:"Delete message",onClick:()=>{a.groupAction("clearchat",{id:t,userId:n})}}),o.push({label:`Delete all from ${i}`,onClick:()=>{a.groupAction("clearchat",{userId:n})}}),o.push({label:`Identify ${i}`,onClick:()=>{a.userAction("identify",n)}}),o.push({label:`Kick out ${i}`,onClick:()=>{a.userAction("kick",n)}}),new Contextual({items:o})}function Be(e){let t=document.getElementById("captions-container"),n=document.getElementById("captions");e?(e instanceof HTMLElement?n.replaceChildren(e):n.textContent=e,t.classList.remove("invisible")):(n.replaceChildren(),t.classList.add("invisible"))}let F=null;function Nt(e){F!=null&&(clearTimeout(F),F=null),Be(e),F=setTimeout(()=>Be(null),3e3)}function L(e){return ge(null,null,null,null,new Date,!1,!1,"",e)}function Ke(e,t){E={};let n=document.getElementById("box");if(!e&&!t){n.textContent="";return}let r=n.children;for(let i=0;i<r.length;i++){let o=r.item(i);if(!(o instanceof HTMLDivElement))continue;let s=o.firstChild;console.log(s),s instanceof HTMLDivElement&&(!e||s.dataset.id===e)&&s.dataset.peerId===t&&n.removeChild(o)}}let u={};function v(){return a&&a.permissions&&a.permissions.indexOf("op")>=0?null:"You are not an operator"}function Ze(){return a&&a.permissions&&a.permissions.indexOf("record")>=0?null:"You are not allowed to record"}u.help={description:"display this help",f:(e,t)=>{let n=[];for(let r in u){let i=u[r];i.description&&(i.predicate&&i.predicate()||n.push(`/${r}${i.parameters?" "+i.parameters:""}: ${i.description}`))}L(n.sort().join(`
`))}};u.me={f:(e,t)=>{throw new Error("this shouldn't happen")}};u.set={f:(e,t)=>{if(!t){let i=w(),o="";for(let s in i)o=o+`${s}: ${JSON.stringify(i[s])}
`;L(o);return}let n=$(t),r;n[1]?r=JSON.parse(n[1]):r=!0,ot(n[0],r),se()}};u.unset={f:(e,t)=>{Ue(t.trim())}};u.leave={description:"leave group",f:(e,t)=>{if(!a)throw new Error("Not connected");a.close()}};u.clear={predicate:v,description:"clear the chat history",f:(e,t)=>{a.groupAction("clearchat")}};u.lock={predicate:v,description:"lock this group",parameters:"[message]",f:(e,t)=>{a.groupAction("lock",t)}};u.unlock={predicate:v,description:"unlock this group, revert the effect of /lock",f:(e,t)=>{a.groupAction("unlock")}};u.record={predicate:Ze,description:"start recording",f:(e,t)=>{a.groupAction("record")}};u.unrecord={predicate:Ze,description:"stop recording",f:(e,t)=>{a.groupAction("unrecord")}};u.subgroups={predicate:v,description:"list subgroups",f:(e,t)=>{a.groupAction("subgroups")}};const J={s:1e3,min:60*1e3,h:60*60*1e3,d:24*60*60*1e3,mon:31*24*60*60*1e3,yr:365*24*60*60*1e3};function Qe(e){if(!e)return null;let n=/^([0-9]+)(s|min|h|d|yr)$/.exec(e);if(n){let i=J[n[2]];if(!i)throw new Error(`Couldn't find unit ${n[2]}`);return parseInt(n[1])*i}let r=new Date(e);if(r.toString()==="Invalid Date")throw new Error("Couldn't parse expiration date");return r}function Gt(){return a.permissions.indexOf("token")<0?"You don't have permission to create tokens":null}function we(){return a.permissions.indexOf("token")<0||a.permissions.indexOf("op")<0?"You don't have permission to edit or list tokens":null}function Yt(e){e||(e={});let t={group:M};"username"in e&&(t.username=e.username),"expires"in e?t.expires=e.expires:t.expires=J.d,"not-before"in e&&(t["not-before"]=e["not-before"]),"permissions"in e?t.permissions=e.permissions:(t.permissions=[],a.permissions.indexOf("present")>=0&&t.permissions.push("present"),a.permissions.indexOf("message")>=0&&t.permissions.push("message")),a.groupAction("maketoken",t)}u.invite={predicate:Gt,description:"create an invitation link",parameters:"[username] [expiration]",f:(e,t)=>{let n=$(t),r={};n[0]&&(r.username=n[0]);let i=Qe(n[1]);i&&(r.expires=i),Yt(r)}};function Xe(e){let t=/^https?:\/\/.*?token=([^?]+)/.exec(e);if(t)return t[1];if(/^https?:\/\//.exec(e))throw new Error("Couldn't parse link");return e}u.reinvite={predicate:we,description:"extend an invitation link",parameters:"link [expiration]",f:(e,t)=>{let n=$(t),r={};r.token=Xe(n[0]),n[1]?r.expires=Qe(n[1]):r.expires=J.d,a.groupAction("edittoken",r)}};u.revoke={predicate:we,description:"revoke an invitation link",parameters:"link",f:(e,t)=>{let n=Xe(t);a.groupAction("edittoken",{token:n,expires:-J.s})}};u.listtokens={predicate:we,description:"list invitation links",f:(e,t)=>{a.groupAction("listtokens")}};function _t(){for(let e in a.up)a.up[e].restartIce();for(let e in a.down)a.down[e].restartIce()}u.renegotiate={description:"renegotiate media streams",f:(e,t)=>{_t()}};u.replace={f:(e,t)=>{Ct(null)}};u.stopshare={description:"stop screen share",f:(e,t)=>{fe("screenshare")}};function $(e){let t=0;for(;t<e.length&&e[t]===" ";)t++;let n=" ";(t<e.length&&e[t]==='"'||e[t]==="'")&&(n=e[t],t++);let r="";for(;t<e.length;){if(e[t]===n){n!==" "&&t++;break}e[t]==="\\"&&t<e.length-1&&t++,r=r+e[t],t++}for(;t<e.length&&e[t]===" ";)t++;return[r,e.slice(t)]}function K(e){if(e in a.users)return e;for(let t in a.users){let n=a.users[t];if(n&&n.username===e)return t}return null}u.msg={parameters:"user message",description:"send a private message",f:(e,t)=>{let n=$(t);if(!n[0])throw new Error("/msg requires parameters");let r=K(n[0]);if(!r)throw new Error(`Unknown user ${n[0]}`);a.chat("",r,n[1]),ge(a.id,null,r,a.username,new Date,!1,!1,"",n[1])}};function T(e,t){let n=$(t);if(!n[0])throw new Error(`/${e} requires parameters`);let r=K(n[0]);if(!r)throw new Error(`Unknown user ${n[0]}`);a.userAction(e,r,n[1])}function et(e,t){let n=$(t);if(!n[0])throw new Error(`/${e} requires parameters`);let r=K(n[0]);if(!r)throw new Error(`Unknown user ${n[0]}`);a.userMessage(e,r,n[1])}u.kick={parameters:"user [message]",description:"kick out a user",predicate:v,f:T};u.identify={parameters:"user [message]",description:"identify a user",predicate:v,f:T};u.op={parameters:"user",description:"give operator status",predicate:v,f:T};u.unop={parameters:"user",description:"revoke operator status",predicate:v,f:T};u.present={parameters:"user",description:"give user the right to present",predicate:v,f:T};u.unpresent={parameters:"user",description:"revoke the right to present",predicate:v,f:T};u.shutup={parameters:"user",description:"revoke the right to send chat messages",predicate:v,f:T};u.unshutup={parameters:"user",description:"give the right to send chat messages",predicate:v,f:T};u.mute={parameters:"user",description:"mute a remote user",predicate:v,f:et};u.muteall={description:"mute all remote users",predicate:v,f:(e,t)=>{a.userMessage("mute",null,null,!0)}};u.warn={parameters:"user message",description:"send a warning to a user",predicate:v,f:(e,t)=>{et("warning",t)}};u.wall={parameters:"message",description:"send a warning to all users",predicate:v,f:(e,t)=>{if(!t)throw new Error("empty message");a.userMessage("warning","",t)}};u.raise={description:"raise hand",f:(e,t)=>{a.userAction("setdata",a.id,{raisehand:!0})}};u.unraise={description:"unraise hand",f:(e,t)=>{a.userAction("setdata",a.id,{raisehand:null})}};function Jt(){return!!HTMLVideoElement.prototype.captureStream||!!HTMLVideoElement.prototype.mozCaptureStream}function Kt(){let e=document.createElement("input");e.type="file",e.accept="audio/*,video/*",e.onchange=function(t){if(!(this instanceof HTMLInputElement))throw new Error("Unexpected type for this");let n=this.files;for(let r=0;r<n.length;r++)St(n[r]).catch(i=>{console.error(i),f(i)})},e.click()}u.presentfile={description:"broadcast a video or audio file",f:(e,t)=>{Kt()},predicate:()=>Jt()?!a||!a.permissions||a.permissions.indexOf("present")<0?"You are not authorised to present.":null:"Your browser does not support presenting arbitrary files"};function Zt(e){let t=document.createElement("input");t.type="file",t.onchange=function(n){if(!(this instanceof HTMLInputElement))throw new Error("Unexpected type for this");let r=this.files;for(let i=0;i<r.length;i++)try{a.sendFile(e,r[i])}catch(o){console.error(o),f(o)}},t.click()}u.sendfile={parameters:"user",description:"send a file (this will disclose your IP address)",f:(e,t)=>{let n=$(t);if(!n[0])throw new Error(`/${e} requires parameters`);let r=K(n[0]);if(!r)throw new Error(`Unknown user ${n[0]}`);Zt(r)}};async function Qt(){if(!a)throw new Error("not connected");let e=Object.assign({},a.getRTCConfiguration());e.iceTransportPolicy="relay";let t=new RTCPeerConnection(e),n=new RTCPeerConnection(e);t.onicecandidate=r=>{r.candidate&&n.addIceCandidate(r.candidate)},n.onicecandidate=r=>{r.candidate&&t.addIceCandidate(r.candidate)};try{return await new Promise(async(r,i)=>{let o=t.createDataChannel("loopbackTest");o.onopen=c=>{o.send(Date.now().toString())};let s=await t.createOffer();await t.setLocalDescription(s),await n.setRemoteDescription(t.localDescription);let l=await n.createAnswer();await n.setLocalDescription(l),await t.setRemoteDescription(n.localDescription),n.ondatachannel=c=>{let y=c.channel;y.onmessage=d=>{let C=parseInt(d.data);isNaN(C)?i(new Error("corrupt data")):r(Date.now()-C)}},setTimeout(()=>i(new Error("timeout")),5e3)})}finally{t.close(),n.close()}}u["relay-test"]={f:async(e,t)=>{L("Relay test in progress...");try{let n=Date.now(),r=await Qt(),i=Date.now();L(`Relay test successful in ${i-n}ms, RTT ${r}ms`)}catch(n){L(`Relay test failed: ${n}`)}}};function tt(){let e=document.getElementById("input"),t=e.value;e.value="";let n,r;if(t!==""){if(t[0]==="/")if(t.length>1&&t[1]==="/")n=t.slice(1),r=!1;else{let i,o,s=t.indexOf(" ");if(s<0?(i=t.slice(1),o=""):(i=t.slice(1,s),o=t.slice(s+1)),i==="me")n=o,r=!0;else{let l=u[i];if(!l){f(`Uknown command /${i}, type /help for help`);return}if(l.predicate){let c=l.predicate();if(c){f(c);return}}try{l.f(i,o)}catch(c){console.error(c),f(c)}return}}else n=t,r=!1;if(!a||!a.socket){f("Not connected.");return}try{a.chat(r?"me":"","",n)}catch(i){console.error(i),f(i)}}}document.getElementById("inputform").onsubmit=function(e){e.preventDefault(),tt()};document.getElementById("input").onkeypress=function(e){e.key==="Enter"&&!e.ctrlKey&&!e.shiftKey&&!e.metaKey&&(e.preventDefault(),tt())};function f(e,t){t||(t="error");let n="center",r="top";switch(t){case"info":n="right",r="bottom";break;case"warning":break;case"kicked":t="error";break}Toastify({text:e,duration:4e3,close:!0,position:n,gravity:r,className:t}).showToast()}function O(e){return f(e,"warning")}document.getElementById("loginform").onsubmit=async function(e){e.preventDefault();let t=this;if(!(t instanceof HTMLFormElement))throw new Error("Bad type for loginform");t.active=!1,nt()};document.getElementById("disconnectbutton").onclick=function(e){a.close()};async function nt(){a&&a.socket&&a.close(),a=new ServerConnection,a.onconnected=st,a.onerror=function(t){console.error(t),f(t.toString())},a.onpeerconnection=ct,a.onclose=ut,a.ondownstream=dt,a.onuser=Ot,a.onjoined=Ht,a.onchat=ge,a.onusermessage=qt,a.onfiletransfer=At;let e=k.endpoint;e||(console.warn("no endpoint in status"),e=`ws${location.protocol==="https:"?"s":""}://${location.host}/ws`);try{await a.connect(e)}catch(t){console.error(t),f(t.message?t.message:"Couldn't connect to "+e)}}async function Xt(){try{let n=await fetch(".status");if(!n.ok)throw new Error(`${n.status} ${n.statusText}`);k=await n.json()}catch(n){console.error(n),O("Couldn't fetch status: "+n),k={}}k.name?M=k.name:(console.warn("no group name in status"),M=decodeURIComponent(location.pathname.replace(/^\/[a-z]*\//,"").replace(/\/$/,"")));let e=new URLSearchParams(window.location.search);if(window.location.search&&window.history.replaceState(null,"",window.location.pathname),k.displayName||Je(M),bt(),await je(!1),se(),e.has("token")&&(S=e.get("token")),S)await nt();else if(k.authPortal)window.location.href=k.authPortal;else{document.getElementById("loginDialog").showModal();var t=Me.get("fullname");t&&g("#username").val(t),document.getElementById("username").focus()}ce(),g("#room-id").text("ID: "+M),g("#room-url").val(k.location),g("#copyroomid").on("click",()=>$e(!0)),g("#close-shareDialog").on("click",()=>$e(!1)),g(".sidebar-toggle").on("click",()=>g("body").toggleClass("has-sidebar"))}function $e(e){e?document.getElementById("shareDialog").showModal():document.getElementById("shareDialog").close()}function tn(){Xt()}export{tn as galeneInit};
